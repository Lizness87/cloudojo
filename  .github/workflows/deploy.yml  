name: Deploy SAM Application

on:
  push:
    branches:
      - dev
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository
      - name: Check out repository
        uses: actions/checkout@v2

      # Step 2: Set up AWS CLI credentials
      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Step 3: Validate SAM template
      - name: Validate SAM Template
        run: |
          sam validate
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # Step 4: Prepare S3 bucket for deployment (Dev/Prod)
      - name: Prepare S3 Bucket for Environment (Dev/Prod)
        run: |
          if [ "${GITHUB_REF##*/}" == "dev" ]; then
            BUCKET_NAME="sam-cloudojo-dev-${{ github.run_id }}"
          elif [ "${GITHUB_REF##*/}" == "prod" ]; then
            BUCKET_NAME="sam-cloudojo-prod-${{ github.run_id }}"
          fi
          # Create the S3 bucket
          aws s3 mb s3://$BUCKET_NAME --region ${{ secrets.AWS_REGION }}
          echo "S3 bucket created: s3://$BUCKET_NAME"
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # Step 5: Upload Kubernetes manifest and Infrastructure files to S3
      - name: Upload Kubernetes and Infrastructure files to S3
        run: |
          if [ "${GITHUB_REF##*/}" == "dev" ]; then
            BUCKET_NAME="sam-cloudojo-dev-${{ github.run_id }}"
          elif [ "${GITHUB_REF##*/}" == "prod" ]; then
            BUCKET_NAME="sam-cloudojo-prod-${{ github.run_id }}"
          fi
          # Upload files to the S3 bucket
          aws s3 cp ./kubernetes s3://$BUCKET_NAME/kubernetes/ --recursive
          aws s3 cp ./infrastructure s3://$BUCKET_NAME/infrastructure/ --recursive
          echo "Files uploaded to s3://$BUCKET_NAME"
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # Step 6: Install SAM CLI (if not already installed)
      - name: Install SAM CLI
        run: |
          curl -Lo sam.tar.gz https://github.com/aws/aws-sam-cli/releases/download/v1.56.0/aws-sam-cli-linux-x86_64.zip
          sudo unzip sam.tar.gz -d /usr/local/bin

      # Step 7: Deploy to Dev Environment
      - name: Deploy to Dev Environment
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          sam deploy --config-env dev
        env:
          AWS_ACCOUNT: "123456789012"
          S3_BUCKET: ${{ secrets.S3_BUCKET_DEV }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # Step 8: Deploy to Prod Environment
      - name: Deploy to Prod Environment
        if: ${{ github.ref == 'refs/heads/prod' }}
        run: |
          sam deploy --config-env prod
        env:
          AWS_ACCOUNT: "987654321098"
          S3_BUCKET: ${{ secrets.S3_BUCKET_PROD }}
          AWS_REGION: ${{ secrets.AWS_REGION }}